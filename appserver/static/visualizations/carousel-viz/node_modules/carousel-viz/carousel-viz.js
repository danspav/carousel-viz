class carousel_viz{
	constructor(){
		this.slides = [];
		this.slidesToShow = 3;
		this.slidesToScroll = 1;
		this.autoplay = true; 
		this.autoplaySpeed = 3000;
		this.colorMode = true;
		this.value = "&nbsp;";
		this.caption="&nbsp;";
		this.unit = "";
		this.numDecimalPlaces="0"
		this.thousandsSeparator = false;
		this.unitPosition = "after";
		this.size = "automatic";
		this.orientation = "horizontal";
		this.direction="left"
		this.rtl=false;
		// Value Options
		this.valueField = "value";
		this.forceAllCaps = false;
		this.numDecimalPlaces = 0;
		this.showDots = false;
		this.isSplunkDarkMode = false;
		this.id = this.createUUID();
		this.validAutoplaySpeeds={"vslow":10000,"slow":7500,"medium":3000,"fast":2000,"vfast":1000};
		this.validSizes={"automatic":250, "xsmall":75,"small":100,"medium":250,"large":300,"xlarge":500};
		this.maxFontSizes = {xsmall:70,small:95,medium:145,large:195,xlarge:240};
		this.height = 250;
	}

	
	
		
	setConfig(config, namespace){
		var vizUtils = require('api/SplunkVisualizationUtils');
		// Get Config parameters:
		this.slidesToShow = parseInt(config[namespace + 'slidesToShow']) || 3;
		this.autoplay = vizUtils.escapeHtml(config[namespace + "autoplay"]) || true;
		this.slidesToScroll = parseInt(config[namespace + 'slidesToScroll']) || 1;
		
		this.forceAllCaps = vizUtils.escapeHtml(config[namespace + "forceAllCaps"]) || false;
		this.autoplaySpeed = vizUtils.escapeHtml(config[namespace + 'autoplaySpeed']) || "normal";
		this.numDecimalPlaces = parseInt(config[namespace + 'numDecimalPlaces']) || 0;
		this.colorMode = vizUtils.escapeHtml(config[namespace + "colorMode"]) || "foreground";
		this.thousandsSeparator = vizUtils.escapeHtml(config[namespace + "thousandsSeparator"]) || false;
		this.unitPosition = vizUtils.escapeHtml(config[namespace + "unitPosition"]) || "after";
		this.defaultCaption = vizUtils.escapeHtml(config[namespace + 'defaultCaption']) || ""; 
		this.size = vizUtils.escapeHtml(config[namespace + 'size']) || "automatic"; 
		this.unit = vizUtils.escapeHtml(config[namespace + 'unit']) || ""; 
		this.caption = vizUtils.escapeHtml(config[namespace + 'caption']) || "&nbsp;"; 
		this.showDots = vizUtils.escapeHtml(config[namespace + 'showDots']) || false; 
		this.orientation = vizUtils.escapeHtml(config[namespace + 'orientation']) || "horizontal"; 
		this.direction = vizUtils.escapeHtml(config[namespace + 'direction']) || "left"; 
		this.rtl = (this.direction=="right" && this.orientation=="horizontal");
		
		if (this.autoplaySpeed < 1000){ this.autoplaySpeed=1000;}
		//Enforce Boolean values to be boolean
		this.forceAllCaps = (this.forceAllCaps=="true");
		this.autoplay=(this.auotplay || this.autoplay=="true");
		this.showDots = (this.showDots=="true");
		this.orientation = (this.orientation=="horizontal") ? "horizontal" : "vertical";
		this.direction = (this.direction=="left") ? "left" : "right";
		this.colorMode = this.colorMode=="foreground" ? "foreground" : "background";
		if(this.numDecimalPlaces >4) { this.numDecimalPlaces=4;}
		if(this.numDecimalPlaces <0) { this.numDecimalPlaces=0;}
		if(this.slidesToShow >10) { this.slidesToShow=10;}
		if(this.slidesToShow <1) { this.slidesToShow=1;}
		if (this.slidesToScroll >  this.slidesToShow) { this.slidesToScroll = this.slidesToShow;}
		if (this.slidesToScroll <  1) { this.slidesToScroll = 1;}

		if(this.unitPosition!="after"){ this.unitPosition="before";}
		if(!this.validAutoplaySpeeds[this.autoplaySpeed]) { this.autoplaySpeed=3000;} else{ this.autoplaySpeed=this.validAutoplaySpeeds[this.autoplaySpeed];}
		if(!this.validSizes[this.size]) { this.size="automatic";}
		this.thousandsSeparator = (this.thousandsSeparator=="true")
		
		this.isSplunkDarkMode = (vizUtils.getCurrentTheme()=="dark");
		
	}
	
	// Create a unique ID for the CSS selector
	createUUID() {
		var s = [];
		var hexDigits = "0123456789abcdef";
		for (var i = 0; i < 10; i++) {
			s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
		}
		var uuid = s.join("");
		return "cv_" + uuid;
	}
	
	
	setData(data){
			var i = 0;
			var fields = [];
			var oSlide;
			var data_item;
			var rangeFieldName = "";
			var current_item;
			var vizUtils = require('api/SplunkVisualizationUtils');
			
			const { carousel_viz, carousel_viz_slide} = require('carousel-viz');
			try{
				//------------------------------  Get data row field indexes ----------------------------------------------------------------------
				for (i=0; i<data.fields.length; i++){
					fields[data.fields[i].name.toLowerCase()]  = i;
				}
				// we don't need to name it "value" - just use the first field
				if(typeof fields["value"] === 'undefined'){ fields['value'] = 0; this.valueField = data.fields[0].name;}
				for (i=0; i<data.rows.length; i++){
					data_item = data.rows[i];
					if(typeof data_item[fields["style"]] === 'undefined'){
						rangeFieldName = "range";
					}else{
						rangeFieldName = "style";
					}
					//------------------------------  Create or Locate item Objects ----------------------------------------------------------------------
					oSlide = new carousel_viz_slide();
					oSlide.value              = vizUtils.escapeHtml(data_item[fields["value"]])
					oSlide.unit               = vizUtils.escapeHtml(data_item[fields["unit"]])
					if (oSlide.unit=="") { oSlide.unit = this.unit;}
					if (typeof fields["caption"] ==='undefined' || data_item[fields["caption"]]==""){ oSlide.caption = this.defaultCaption;} else {oSlide.caption=vizUtils.escapeHtml(data_item[fields["caption"]]);}
					if (typeof fields["range"] ==='undefined' || data_item[fields["range"]]==""){ oSlide.range = "default";}else{oSlide.range=vizUtils.escapeHtml(data_item[fields[rangeFieldName]]);}
					
					oSlide.size				  = this.size;
					oSlide.forceAllCaps       = this.forceAllCaps;
					oSlide.numDecimalPlaces   = this.numDecimalPlaces;
					oSlide.colorMode          = this.colorMode;
					oSlide.thousandsSeparator = this.thousandsSeparator;
					oSlide.unitPosition	      = this.unitPosition;
					oSlide.valueField 		  = this.valueField;					
					this.slides.push(oSlide);
				}	
			} catch(err) {
				console.log("Error setting data. " + err);
			}
		}
	
	
	getHTML(){
		console.log("Carousel ID=" + this.id);
		var html = "";
		var dir = "";
		if (this.rtl && this.orientation=="horizontal") { dir=" dir=\"rtl\"";} else{dir=" dir=\"ltr\"";} // Bug: can only do rtl if horizontal: https://github.com/kenwheeler/slick/issues/818
		if (this.isSplunkDarkMode){
			html += "<style>.slick-dots li button:before, .slick-dots li.slick-active button:before{color:white!important;}</style>";
		}
		var value = this.value
		var i =0;
		 html +='<div id="'  + this.id + '" class="carousel-viz-container"' + dir + '>';
		 for(i=0;i<this.slides.length;i++){
			 html += this.slides[i].getHTML();
		 }
		 html += '</div>';
		 return html;
	}
	
	start(){
		var objCarousel = this;
				
		var isVertical = (this.orientation=="vertical");
			window.jQuery('#' + this.id).slick({
				rtl: (!isVertical  && this.rtl),
				centerMode: false,
				dots: this.showDots,
				vertical: isVertical,
				verticalSwiping: isVertical,
				arrows: false,
				infinite: true, 			// Bug causes odd number of horizontal slides to stop when infinite is false. 
				variableWidth: false,		// Causes duplicates when animating horizontally. Causes gaps when horizontal.
				centerPadding: '60px',
				slidesToShow: objCarousel.slidesToShow,
				slidesToScroll: objCarousel.slidesToScroll,
				autoplay: objCarousel.autoplay,
				autoplaySpeed: objCarousel.autoplaySpeed,
				adaptiveHeight: isVertical,	// Only used for Vertical Display?
				pauseOnFocus: true,
				focusOnSelect: true,
				cssEase: 'ease'
			});

			//objCarousel.height = height;
			var maxFontSize = (.7* objCarousel.height ) -15; // take 80% of the CSS height for the value div to allow for padding.
			window.jQuery("div#" + objCarousel.id + " div.value").textfill({ allowOverflow: false, changeLineHeight: false, maxFontPixels: maxFontSize,minFontPixels: 12, widthOnly: true });
			window.jQuery("div#" + objCarousel.id + " div.caption").textfill({ allowOverflow: false, changeLineHeight: false, maxFontPixels: 18, minFontPixels: 8,widthOnly: false });
			
			
		
		}
	
	//Called when the visualization is resized
	resize(height){
		var objCarousel=this;
		var isVertical = (this.orientation=="vertical");
		var verticalSlideHeight = 0;
		var newHeight; 
		var slideHeight;
		objCarousel.height = height;
		
		var maxFontSize = (.7 * objCarousel.height ) - 15; // take 70% of the CSS height for the value div to allow for padding.
		//If we have automatic sizing, update the size of the slides. 
		// Special case for vertical with objCarousel.slidesToShow >1
		// Seems to be 0.9 high....
		if(isVertical){
			// Make the container fit the number of slides to an integer height - including all margins, padding, and borders
			newHeight = Math.floor(height / objCarousel.slidesToShow) * objCarousel.slidesToShow;
			
			//each container has a 1px border - account for that with no margin/padding
			slideHeight = (newHeight / objCarousel.slidesToShow) - (17 * objCarousel.slidesToShow); // 2px for border, 15px for margin
			
			//Now account for the 15px margin:
			
			//slideHeight -= 15;
			
			
			window.jQuery("div#" + this.id).height(newHeight);
			window.jQuery("div#" + this.id +" div.singlevaluebox").height(slideHeight);
			console.log("Original Height: "  + height);
			console.log("New Height: "  + newHeight);
			console.log("Slide Height: "  + slideHeight);
			
			
		}else if(objCarousel.size=="automatic"){
			window.jQuery("div#" + this.id).height(0.9*height - 30);
			window.jQuery("div#" + this.id +" div.singlevaluebox").height(.9*height-15);
		}
				
		setTimeout(function(){ 
			window.jQuery("div#" + objCarousel.id + " div.value").textfill({ allowOverflow: false, changeLineHeight: false, maxFontPixels: maxFontSize,minFontPixels: 12, widthOnly: true });
			window.jQuery("div#" + objCarousel.id + " div.caption").textfill({ allowOverflow: false, changeLineHeight: false, maxFontPixels: 18, minFontPixels: 6,widthOnly: false });
		},1000);
	}
	
	
	}
	
	
	/* Slide class
		This class defines a slide in the carousel.
		There will be multiple instances, each showing a different row of the results.
	*/
	class carousel_viz_slide{

		constructor(){
			this.value = "";	
			this.valueField = "value";
			this.caption = "";	
			this.unit = "";
			this.range = "";
			this.forceAllCaps = false;
			this.numDecimalPlaces = 0;
			this.colorMode = "foreground";
			this.thousandsSeparator = false;
			this.unitPosition = "right";
			this.rtl = false
			this.size = "normal";
		}
		
		/* Returns the CSS class for the current slide based on Range/Style and colorMode status */
		getStyle(){
			var style = this.size;
			if(!this.range){this.range="";}
			if (this.size=="automatic"){ style="automatic";}
			switch(this.range.toLowerCase()){
				case "low":
				case "green":
				case "ok":
					style += " green";
					break;
				case "elevated":
				case "yellow":
				case "amber":
				case "orange":
				case "warning":
					style += " yellow";
					break;
				case "severe":
				case "critical":
				case "red":
					style +=" red";
					break;
				default:
					style +=" default";
					break;
			}
		
			if (this.colorMode=="background"){
				style += 'Block';
			}else{
				style += 'NoBackground';
			}
			
			return style;
		}

		
	numberWithCommas(x){
		var parts = x.toString().split(".");
		parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		return parts.join(".");
	}
	

		//Format the value - eg UPPERCASE, 1,000  23.22
		getValue(){
			var formattedValue =this.value;
			
			if(! isNaN(formattedValue) && formattedValue!=""){
				formattedValue = parseFloat(formattedValue).toFixed(this.numDecimalPlaces);
				if(this.thousandsSeparator){ formattedValue = this.numberWithCommas(formattedValue);}
			}
			
			if (this.forceAllCaps){
				formattedValue = formattedValue.toUpperCase();
			}
			
			return formattedValue;
		}
		
		/* A simple HTML block representing the Slide's HTML content. */
		getHTML(){
			var vizUtils = require('api/SplunkVisualizationUtils');
			var captionText = this.caption;
			if (captionText==""){captionText="&nbsp;";}
			var html = "";
			html += '<div class="singlevaluebox ' + this.getStyle() + '" dir="ltr">'; // dir=ltr makes sure the unit position is obeyed
			
			if(this.unitPosition=="before"){
				html += '<div class="value"><span valueField="' + this.valueField + '" rawValue="' + vizUtils.escapeHtml(this.value) + '">' + this.unit + '&thinsp;'+  this.getValue() +  '</span></div>';
			}else{
				html += '<div class="value"><span valueField="' + this.valueField + '" rawValue="' + vizUtils.escapeHtml(this.value) + '">' + this.getValue() + '&thinsp;' + this.unit +  '</span></div>';
			}
			html += '<div class="caption"><span>' + this.caption + '</span></div>';
			html += '</div>';
			return html;
		}
		
		

		
		
	}
	
	
	
module.exports = { carousel_viz, carousel_viz_slide}
